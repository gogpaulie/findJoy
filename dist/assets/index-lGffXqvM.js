var E=Object.defineProperty;var C=(r,e,t)=>e in r?E(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var a=(r,e,t)=>C(r,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class I{constructor(e,t){a(this,"canvas");a(this,"ctx");a(this,"characters",[]);a(this,"worker");a(this,"characterImages",{});a(this,"audioManager");a(this,"settings");a(this,"animationFrameId",0);a(this,"points",0);a(this,"isWindowFocused",!0);a(this,"isGameRunning",!1);a(this,"animateAll",()=>{this.isWindowFocused&&this.isGameRunning&&(this.worker.postMessage({type:"animate",time:performance.now()}),this.animationFrameId=requestAnimationFrame(this.animateAll))});this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.audioManager=e,this.settings=t.getSettings(),this.worker=new Worker(new URL("/assets/animation-worker-Dn1ckAW9.js",import.meta.url),{type:"module"}),this.loadCharacterImages(),this.setupEventListeners()}loadCharacterImages(){["FindJoy-Joy","FindJoy-Byte-Joypalette","FindJoy-Byte","FindJoy-Coop-Joypalette","FindJoy-Coop","FindJoy-Faith-Joypalette","FindJoy-Faith","FindJoy-Velocity-Joypalette","FindJoy-Velocity"].forEach(e=>{const t=new Image;t.src=`img/character/${e}.png`,this.characterImages[e]=t})}setupEventListeners(){this.worker.onmessage||(this.worker.onmessage=this.handleWorkerMessage.bind(this)),this.canvas.removeEventListener("click",this.handleCanvasClick.bind(this)),this.canvas.addEventListener("click",this.handleCanvasClick.bind(this)),window.removeEventListener("focus",this.handleWindowFocus.bind(this)),window.removeEventListener("blur",this.handleWindowBlur.bind(this)),window.addEventListener("focus",this.handleWindowFocus.bind(this)),window.addEventListener("blur",this.handleWindowBlur.bind(this))}handleWorkerMessage(e){const{type:t,positions:s}=e.data;t==="update"&&(s.forEach((i,n)=>{this.characters[n]&&(this.characters[n].x=i.x,this.characters[n].y=i.y)}),this.drawCharacters())}drawCharacters(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.imageSmoothingEnabled=!1,this.characters.forEach(({img:e,x:t,y:s,width:i,height:n})=>{this.ctx.drawImage(e,t,s,i,n)})}addCharacter(e,t){const s=Math.random()*(this.canvas.width-e.width),i=Math.random()*(this.canvas.height-e.height),n=(Math.random()-.5)*this.settings.speed,o=(Math.random()-.5)*this.settings.speed;this.characters.push({img:this.characterImages[e.name],x:s,y:i,width:e.width,height:e.height}),t.push({x:s,y:i,dx:n,dy:o,width:e.width,height:e.height})}init(){this.canvas.width=960,this.canvas.height=540,this.canvas.style.width="100%",this.canvas.style.height="100%";const e=[{name:"FindJoy-Joy",width:60,height:60},this.settings.useByte&&{name:"FindJoy-Byte",width:60,height:60},this.settings.useByteJ&&{name:"FindJoy-Byte-Joypalette",width:60,height:60},this.settings.useCoop&&{name:"FindJoy-Coop",width:60,height:60},this.settings.useCoopJ&&{name:"FindJoy-Coop-Joypalette",width:60,height:60},this.settings.useFaith&&{name:"FindJoy-Faith",width:60,height:60},this.settings.useFaithJ&&{name:"FindJoy-Faith-Joypalette",width:60,height:60},this.settings.useVelocity&&{name:"FindJoy-Velocity",width:60,height:60},this.settings.useVelocityJ&&{name:"FindJoy-Velocity-Joypalette",width:60,height:60}].filter(Boolean),t=this.settings.minIcons,s=this.settings.maxIcons,i=Math.floor(Math.random()*(s-t+1))+t,n=[];this.characters=[],this.addCharacter(e[0],n);for(let o=0;o<i;o++){let l=e[o%e.length];l.name==="FindJoy-Joy"&&(l=e[(o+1)%e.length]),this.addCharacter(l,n)}this.settings.shuffleCharacterLayers&&(this.characters=this.shuffleArray(this.characters)),this.worker.postMessage({type:"init",iconData:n,gameWidth:this.canvas.width,gameHeight:this.canvas.height,movementThreshold:this.settings.movementThreshold,useInterpolation:this.settings.useInterpolation}),this.isGameRunning=!0,this.animationFrameId=requestAnimationFrame(this.animateAll)}handleCanvasClick(e){const t=this.canvas.getBoundingClientRect(),s=this.canvas.width,i=this.canvas.height,n=Math.min(t.width/s,t.height/i),o=s*n,l=i*n,p=(t.width-o)/2,f=(t.height-l)/2,c=(e.clientX-t.left-p)/n,u=(e.clientY-t.top-f)/n;this.characters.forEach(({x:d,y:m,width:y,height:w,img:F})=>{c>=d&&c<=d+y&&u>=m&&u<=m+w&&F===this.characterImages.luigi&&this.isGameRunning&&(cancelAnimationFrame(this.animationFrameId),this.worker&&this.worker.terminate(),this.isGameRunning=!1,this.settings.SFX&&this.audioManager.playRandomCaughtSound(),this.points++,console.log("Points:",this.points),this.characters=this.characters.filter(v=>v.img===this.characterImages.luigi),this.drawCharacters(),setTimeout(()=>this.restartGame(),3e3))})}restartGame(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.worker=new Worker(new URL("/assets/animation-worker-Dn1ckAW9.js",import.meta.url),{type:"module"}),this.setupEventListeners(),this.init()}handleWindowFocus(){this.isWindowFocused=!0,this.isGameRunning&&(this.canvas.style.display="flex",document.getElementById("unfocusedNotice").style.display="none",this.worker.postMessage({type:"pause",paused:!1}),cancelAnimationFrame(this.animationFrameId),this.animationFrameId=requestAnimationFrame(this.animateAll))}handleWindowBlur(){this.isWindowFocused=!1,this.isGameRunning&&(this.canvas.style.display="none",document.getElementById("unfocusedNotice").style.display="block",this.worker.postMessage({type:"pause",paused:!0}))}shuffleArray(e){for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}}const h={useByte:!0,useByteJ:!1,useCoop:!0,useCoopJ:!1,useFaith:!0,useFaithJ:!1,useVelocity:!0,useVelocityJ:!1,shuffleCharacterLayers:!0,useInterpolation:!1,showFPS:!0,music:!0,SFX:!0,movementThreshold:1,minIcons:50,maxIcons:100,speed:400};class S{constructor(e=localStorage){a(this,"settings");a(this,"inputElements");a(this,"speedLabel");this.storage=e,this.inputElements=this.getInputElements(),this.settings=this.loadSettings(),this.speedLabel=document.getElementById("speedFieldLabel"),this.applyUIValues(),this.setupEventListeners()}getInputElements(){return{useByte:document.getElementById("useByteCheckbox"),useByteJ:document.getElementById("useByteJCheckbox"),useCoop:document.getElementById("useCoopCheckbox"),useCoopJ:document.getElementById("useCoopJCheckbox"),useFaith:document.getElementById("useFaithCheckbox"),useFaithJ:document.getElementById("useFaithJCheckbox"),useVelocity:document.getElementById("useVelocityCheckbox"),useVelocityJ:document.getElementById("useVelocityJCheckbox"),shuffleCharacterLayers:document.getElementById("shuffleLayersCheckbox"),useInterpolation:document.getElementById("useInterpolationCheckbox"),showFPS:document.getElementById("showFPSCheckbox"),music:document.getElementById("musicCheckbox"),SFX:document.getElementById("sfxCheckbox"),movementThreshold:document.getElementById("movementThresholdField"),minIcons:document.getElementById("minimumIconsField"),maxIcons:document.getElementById("maximumIconsField"),speed:document.getElementById("speedField")}}loadSettings(){return Object.fromEntries(Object.entries(h).map(([e,t])=>[e,this.getAndParseLocalStorage(e,typeof t=="boolean"?this.parseBoolean:parseInt,t)]))}applyUIValues(){Object.entries(this.inputElements).forEach(([e,t])=>{const s=e;typeof this.settings[s]=="boolean"?t.checked=this.settings[s]:t.value=this.settings[s].toString()}),this.updateSpeedLabel()}setupEventListeners(){this.inputElements.speed.addEventListener("input",()=>{this.updateSpeedLabel();const e=parseInt(this.inputElements.speed.value);isNaN(e)||(this.settings.speed=e)})}updateSpeedLabel(){this.speedLabel.childNodes[0].textContent=`Speed (value: ${this.inputElements.speed.value})`}setSetting(e,t){this.settings[e]=t}applySettings(){Object.entries(this.inputElements).forEach(([e,t])=>{const s=e;if(typeof h[s]=="boolean")this.setSetting(s,t.checked);else if(typeof h[s]=="number"){const i=parseInt(t.value,10);isNaN(i)||this.setSetting(s,i)}this.storage.setItem(s,this.settings[s].toString())}),window.location.reload()}getAndParseLocalStorage(e,t,s){const i=this.storage.getItem(e);return i!==null?t(i):s}parseBoolean(e){return(e==null?void 0:e.toString().toLowerCase())==="true"||e==="1"}getSettings(){return this.settings}}class B{constructor(){a(this,"audioContext");a(this,"audioBuffers",new Map);a(this,"playingSources",new Map);a(this,"gainNodes",new Map);a(this,"audioManifest",{music:{url:"audio/music.mp3",loop:!0,volume:.6},luigi_caught_1:{url:"audio/luigi_caught_1.wav",volume:1},luigi_caught_2:{url:"audio/luigi_caught_2.wav",volume:1},luigi_caught_3:{url:"audio/luigi_caught_3.wav",volume:1}});this.audioContext=new AudioContext}async loadAll(){const e=Object.entries(this.audioManifest);for(const[t,s]of e)try{const n=await(await fetch(s.url)).arrayBuffer(),o=await this.audioContext.decodeAudioData(n);this.audioBuffers.set(t,o);const l=this.audioContext.createGain();l.gain.value=s.volume??1,l.connect(this.audioContext.destination),this.gainNodes.set(t,l)}catch(i){console.error(`Failed to load audio for key "${t}":`,i)}}async play(e){const t=this.audioBuffers.get(e),s=this.gainNodes.get(e);if(!t||!s)return console.warn(`Missing audio buffer or gain node for key "${e}".`),!1;this.audioContext.state==="suspended"&&await this.audioContext.resume();const i=this.audioContext.createBufferSource();return i.buffer=t,i.loop=this.audioManifest[e].loop??!1,i.connect(s),i.start(0),i.loop&&(this.stop(e),this.playingSources.set(e,i)),!0}stop(e){const t=this.playingSources.get(e);if(t){try{t.stop()}catch(s){console.warn(`Failed to stop audio for key "${e}":`,s)}this.playingSources.delete(e)}}mute(){this.audioContext.suspend()}unmute(){this.audioContext.resume()}setVolume(e,t){const s=this.gainNodes.get(e);s&&(s.gain.value=Math.max(0,Math.min(t,1)))}playRandomCaughtSound(){const e=["luigi_caught_1","luigi_caught_2","luigi_caught_3"],t=e[Math.floor(Math.random()*e.length)];this.play(t)}}let g;class b{constructor(){a(this,"settingsManager",new S);a(this,"audioManager",new B);a(this,"settings",this.settingsManager.getSettings());a(this,"gameInstance",null);a(this,"initializationPromise",null);a(this,"fpsSamples",[]);a(this,"fps",0);a(this,"elements");this.elements=this.getElements(),this.registerAlertHandlers(),this.registerStartHandler(),this.registerSettingsHandler(),this.registerFullscreenHandlers(),this.startFpsTracking(),window.addEventListener("load",()=>{this.initialize().catch(e=>{console.error("Unable to initialize game on load",e)})})}getElements(){return{gameWindow:this.requireElement("game"),fullscreenButton:this.requireElement("fullscreenButton"),startButton:this.requireElement("startButton"),fpsCounter:this.requireElement("fpsCounter"),customAlertOverlay:this.requireElement("customAlertOverlay"),customAlertText:this.requireElement("customAlertText"),customAlertClose:this.requireElement("customAlertClose"),applySettingsButton:this.requireElement("applySettingsButton")}}requireElement(e){const t=document.getElementById(e);if(!t)throw new Error(`Missing element with id "${e}"`);return t}registerAlertHandlers(){this.elements.customAlertClose.addEventListener("click",()=>this.hideCustomAlert())}registerStartHandler(){this.elements.startButton.addEventListener("click",()=>this.handleStartClick())}registerSettingsHandler(){this.elements.applySettingsButton.addEventListener("click",()=>this.settingsManager.applySettings())}registerFullscreenHandlers(){this.elements.fullscreenButton.addEventListener("click",()=>this.toggleFullscreen()),document.addEventListener("fullscreenchange",()=>this.updateFullscreenButton()),this.updateFullscreenButton()}startFpsTracking(){this.trackFpsSamples(),setInterval(()=>this.updateFpsDisplay(),1e3)}trackFpsSamples(){requestAnimationFrame(()=>{const e=performance.now();for(;this.fpsSamples.length>0&&this.fpsSamples[0]<=e-1e3;)this.fpsSamples.shift();this.fpsSamples.push(e),this.fps=this.fpsSamples.length,this.trackFpsSamples()})}updateFpsDisplay(){g=this.fps;const{fpsCounter:e}=this.elements;this.settings.showFPS?(e.hidden=!1,e.textContent=`FPS: ${g}`):e.hidden=!0}async initialize(){this.gameInstance||(this.initializationPromise||(this.initializationPromise=this.prepareGame().catch(e=>{throw this.initializationPromise=null,console.error("Failed to initialize game",e),e})),await this.initializationPromise)}async prepareGame(){await this.audioManager.loadAll(),this.settings.music||this.audioManager.setVolume("music",0),this.attachInfoIconHandlers(),this.gameInstance=new I(this.audioManager,this.settingsManager)}attachInfoIconHandlers(){document.querySelectorAll(".info-label .label-info-icon").forEach(e=>{const t=e;t.title&&t.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),this.showCustomAlert(t.title)})})}async handleStartClick(){const{startButton:e}=this.elements;if(e.disabled)return;e.disabled=!0;try{await this.initialize()}catch(s){e.disabled=!1,console.error("Start aborted due to initialization failure",s);return}if(e.style.visibility="hidden",await this.audioManager.play("music")||console.warn("Music did not start"),!this.gameInstance){e.disabled=!1,e.style.visibility="visible",console.error("Game instance missing after initialization");return}this.gameInstance.init()}toggleFullscreen(){const{gameWindow:e}=this.elements;if(!document.fullscreenElement){e.requestFullscreen();return}document.exitFullscreen()}updateFullscreenButton(){const{fullscreenButton:e}=this.elements;e.textContent=document.fullscreenElement?"Exit Fullscreen":"Fullscreen"}showCustomAlert(e){const{customAlertOverlay:t,customAlertText:s}=this.elements;s.textContent=e,t.style.display="flex",document.documentElement.style.overflow="hidden",document.body.style.overflow="hidden"}hideCustomAlert(){const{customAlertOverlay:e,customAlertText:t}=this.elements;e.style.display="none",t.textContent="",document.documentElement.style.overflow="",document.body.style.overflow=""}}new b;
